name: Build
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: Build 
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Use Node.js 16.x
        uses: actions/setup-node@v4
        with:
          node-version: 16

      - name: Install
        run: npm ci

      - name: Build
        env:
          SITE_URL: ${{ vars.SITE_URL }}
          BAKER_PATH_PREFIX: ${{ vars.BAKER_PATH_PREFIX }}
          CUSTOM_DOMAIN: ${{ vars.CUSTOM_DOMAIN }}
        run: |
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          SITE_URL="${SITE_URL:-https://${GITHUB_REPOSITORY_OWNER}.github.io/${REPO_NAME}}"
          if [ -n "${CUSTOM_DOMAIN}" ]; then
            DEFAULT_BAKER_PATH_PREFIX="/"
          else
            DEFAULT_BAKER_PATH_PREFIX="/${REPO_NAME}/"
          fi
          BAKER_PATH_PREFIX="${BAKER_PATH_PREFIX:-${DEFAULT_BAKER_PATH_PREFIX}}"
          echo "Building with SITE_URL=${SITE_URL}"
          echo "Building with BAKER_PATH_PREFIX=${BAKER_PATH_PREFIX}"
          SITE_URL="${SITE_URL}" BAKER_PATH_PREFIX="${BAKER_PATH_PREFIX}" npm run-script build
          if [ -n "${CUSTOM_DOMAIN}" ]; then
            echo "${CUSTOM_DOMAIN}" > _dist/CNAME
          fi
          touch _dist/.nojekyll
          echo 'encoding: UTF-8' > _dist/_config.yml

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _dist

  deploy:
    name: Deploy
    needs: build
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - id: deployment
        name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
